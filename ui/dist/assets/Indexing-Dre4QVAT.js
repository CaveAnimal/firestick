import{j as e}from"./index-BITMq2dn.js";import{r as n}from"./react-CrAnlijj.js";import{c as k,d as N,s as $}from"./index-Q6vxWtnJ.js";import"./monaco-amF-kVe2.js";import"./recharts-BIV-EGEs.js";function V({value:t}){const a=Math.max(0,Math.min(100,Math.round(t)));return e.jsx("div",{style:{height:12,background:"#eee",borderRadius:6,overflow:"hidden"},children:e.jsx("div",{style:{width:`${a}%`,background:"#1976d2",height:"100%"}})})}function z({message:t,type:a="info",durationMs:g=3e3}){const[b,h]=n.useState(!0);if(n.useEffect(()=>{const m=setTimeout(()=>h(!1),g);return()=>clearTimeout(m)},[g]),!b)return null;const p=a==="error"?"#f44336":a==="success"?"#4caf50":"#333";return e.jsx("div",{style:{position:"fixed",right:16,bottom:16,background:p,color:"#fff",padding:"10px 14px",borderRadius:6,boxShadow:"0 2px 8px rgba(0,0,0,0.2)"},children:t})}function U(){const[t,a]=n.useState(null),[g,b]=n.useState([]),[h,p]=n.useState(!1),[m,j]=n.useState(),[R,T]=n.useState(),[E,S]=n.useState(!1),[B,D]=n.useState(null),[v,L]=n.useState(localStorage.getItem("idx.root")||""),[w,P]=n.useState(localStorage.getItem("idx.excludeDirs")||""),[I,A]=n.useState(localStorage.getItem("idx.excludeGlobs")||""),o=n.useRef(null);async function u(){try{const s=await k();a(s)}catch(s){j((s==null?void 0:s.message)??"Failed to load latest job")}}async function M(){try{const s=await N(10);b(s)}catch{}}const i=n.useRef(null),C=n.useRef(!1),x=n.useRef(null),y=n.useRef(1e3),G=15e3;function J(){localStorage.setItem("idx.root",v),localStorage.setItem("idx.excludeDirs",w),localStorage.setItem("idx.excludeGlobs",I)}async function F(){p(!0),j(void 0);try{const s=w.split(",").map(r=>r.trim()).filter(Boolean),d=I.split(",").map(r=>r.trim()).filter(Boolean),l=await $({root:v.trim()||void 0,excludeDirs:s.length?s:void 0,excludeGlobs:d.length?d:void 0});J(),T(`Indexing started${l!=null&&l.jobId?` (job ${l.jobId})`:""}`),o.current&&window.clearInterval(o.current);try{const r=await k();r!=null&&r.id?f(r.id):o.current=window.setInterval(u,1500)}catch{o.current=window.setInterval(u,1500)}await u()}catch(s){j((s==null?void 0:s.message)??"Failed to start indexing")}finally{p(!1)}}n.useEffect(()=>(u(),M(),()=>{o.current&&window.clearInterval(o.current),i.current&&(i.current.close(),i.current=null)}),[]),n.useEffect(()=>{if(t!=null&&t.id){if(typeof t.progress=="number"&&t.progress>=100){i.current&&(i.current.close(),i.current=null);return}!i.current&&!C.current&&f(t.id)}},[t==null?void 0:t.id,t==null?void 0:t.progress]);function f(s){C.current=!0;try{i.current&&(i.current.close(),i.current=null),x.current&&(window.clearTimeout(x.current),x.current=null);const d=new EventSource(`/api/indexing/stream?jobId=${s}`);i.current=d,d.onopen=()=>{S(!0)},d.onmessage=l=>{try{const r=JSON.parse(l.data);D(Date.now()),a(c=>({...c||{},id:s,status:(r==null?void 0:r.status)??(c==null?void 0:c.status),progress:typeof(r==null?void 0:r.percent)=="number"?r.percent:c==null?void 0:c.progress,stats:{filesParsed:r==null?void 0:r.filesParsed,filesDiscovered:r==null?void 0:r.filesDiscovered,chunksProduced:r==null?void 0:r.chunksProduced,documentsIndexed:r==null?void 0:r.documentsIndexed,embeddingsGenerated:r==null?void 0:r.embeddingsGenerated,filesSkipped:r==null?void 0:r.filesSkipped}})),(r==null?void 0:r.percent)>=100&&(d.close(),i.current=null,S(!1))}catch{}},d.onerror=()=>{d.close(),i.current=null,S(!1);const l=y.current;y.current=Math.min(G,Math.floor(y.current*1.8)),x.current&&window.clearTimeout(x.current),x.current=window.setTimeout(()=>{s&&f(s)},l)}}catch{o.current&&window.clearInterval(o.current),o.current=window.setInterval(u,2e3)}}const O=typeof(t==null?void 0:t.progress)=="number"?t.progress:(t==null?void 0:t.status)==="COMPLETED"?100:0;return e.jsxs("div",{children:[e.jsx("h2",{children:"Indexing Console"}),e.jsxs("fieldset",{style:{border:"1px solid #eee",borderRadius:6,padding:12,marginBottom:12},children:[e.jsx("legend",{style:{padding:"0 6px",color:"#555"},children:"Configuration"}),e.jsxs("div",{style:{display:"grid",gap:8},children:[e.jsxs("label",{style:{display:"grid",gap:4},children:[e.jsx("span",{children:"Root Path (optional)"}),e.jsx("input",{value:v,onChange:s=>L(s.target.value),placeholder:"e.g. E:\\\\code\\\\my-project"})]}),e.jsxs("label",{style:{display:"grid",gap:4},children:[e.jsx("span",{children:"Exclude Directories (CSV)"}),e.jsx("input",{value:w,onChange:s=>P(s.target.value),placeholder:"e.g. node_modules, .git, target"})]}),e.jsxs("label",{style:{display:"grid",gap:4},children:[e.jsx("span",{children:"Exclude Globs (CSV)"}),e.jsx("input",{value:I,onChange:s=>A(s.target.value),placeholder:"e.g. **/*.min.js, **/*.map"})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8,marginBottom:12},children:[e.jsx("button",{onClick:F,disabled:h,children:"Trigger Indexing"}),e.jsx("button",{onClick:u,disabled:h,children:"Refresh"}),e.jsx("button",{onClick:()=>{t!=null&&t.id&&(y.current=1e3,f(t.id))},disabled:!(t!=null&&t.id),children:"Reconnect"})]}),m&&e.jsxs("div",{style:{color:"red",marginBottom:8},children:["Error: ",m]}),e.jsx("div",{style:{border:"1px solid #eee",borderRadius:6,padding:12},children:e.jsxs("div",{style:{display:"grid",gap:6},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Job ID:"})," ",(t==null?void 0:t.id)??"—"]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("strong",{children:"Status:"}),e.jsx("span",{style:{padding:"2px 8px",borderRadius:999,background:(t==null?void 0:t.status)==="COMPLETED"?"#e8f5e9":(t==null?void 0:t.status)==="FAILED"?"#ffebee":"#e3f2fd",color:(t==null?void 0:t.status)==="COMPLETED"?"#2e7d32":(t==null?void 0:t.status)==="FAILED"?"#c62828":"#1565c0",border:"1px solid #eee"},children:(t==null?void 0:t.status)??"—"}),e.jsxs("span",{title:E?"Live (SSE connected)":"Not live",style:{display:"inline-flex",alignItems:"center",gap:4},children:[e.jsx("span",{style:{width:8,height:8,borderRadius:"50%",background:E?"#2ecc71":"#bdc3c7"}}),e.jsx("span",{style:{fontSize:12,color:"#666"},children:"live"})]}),B&&e.jsxs("span",{style:{marginLeft:"auto",fontSize:12,color:"#666"},children:["Last update: ",new Date(B).toLocaleTimeString()]})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Progress:"})," ",e.jsx(V,{value:O})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Started:"})," ",(t==null?void 0:t.startTime)??"—"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Finished:"})," ",(t==null?void 0:t.endTime)??"—"]}),(t==null?void 0:t.stats)&&e.jsx("pre",{style:{background:"#fafafa",padding:8},children:JSON.stringify(t.stats,null,2)})]})}),e.jsx("h3",{style:{marginTop:16},children:"Recent Jobs"}),e.jsx("div",{style:{border:"1px solid #eee",borderRadius:6,padding:8},children:g.length===0?e.jsx("div",{children:"No jobs yet"}):e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{textAlign:"left",padding:6,borderBottom:"1px solid #eee"},children:"ID"}),e.jsx("th",{style:{textAlign:"left",padding:6,borderBottom:"1px solid #eee"},children:"Status"}),e.jsx("th",{style:{textAlign:"left",padding:6,borderBottom:"1px solid #eee"},children:"Started"}),e.jsx("th",{style:{textAlign:"left",padding:6,borderBottom:"1px solid #eee"},children:"Ended"}),e.jsx("th",{style:{textAlign:"left",padding:6,borderBottom:"1px solid #eee"},children:"Files"}),e.jsx("th",{style:{textAlign:"left",padding:6,borderBottom:"1px solid #eee"},children:"Chunks"})]})}),e.jsx("tbody",{children:g.map(s=>{var d,l;return e.jsxs("tr",{style:{cursor:"pointer"},onClick:()=>{a(s),s.id&&f(s.id)},title:"Open job",children:[e.jsx("td",{style:{padding:6,borderBottom:"1px solid #f5f5f5"},children:String(s.id)}),e.jsx("td",{style:{padding:6,borderBottom:"1px solid #f5f5f5"},children:s.status}),e.jsx("td",{style:{padding:6,borderBottom:"1px solid #f5f5f5"},children:s.startTime??""}),e.jsx("td",{style:{padding:6,borderBottom:"1px solid #f5f5f5"},children:s.endTime??""}),e.jsx("td",{style:{padding:6,borderBottom:"1px solid #f5f5f5"},children:((d=s.stats)==null?void 0:d.filesParsed)??0}),e.jsx("td",{style:{padding:6,borderBottom:"1px solid #f5f5f5"},children:((l=s.stats)==null?void 0:l.chunksProduced)??0})]},String(s.id))})})]})}),R&&e.jsx(z,{message:R,type:"success"})]})}export{U as default};
